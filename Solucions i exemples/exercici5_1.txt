/*5. Cread un bloque PL/SQL que os permita:
	Primero:
		- Buscar el trabajador con más clientes
    - Buscar el cliente de ese trabajador con más productos relacionados
    - Mostrar el nombre del cliente*/

-- Código para añadir los datos necesarios de productos
    
CREATE SEQUENCE SEQ_PROD_CUSTOMER
START WITH 1
INCREMENT BY 1;

INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 2, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 4, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 5, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 5, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 5, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 5, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 6, SYSDATE);
INSERT INTO PRODUCT_CUSTOMER(PRODUCT_ID, CUSTOMER_ID, CREATION_DATE) VALUES(SEQ_PROD_CUSTOMER.NEXTVAL, 6, SYSDATE);    

-- Inicio código ejercicio

SET SERVEROUTPUT ON
DECLARE 
  emp_id VARCHAR2(20);
  cli_nom VARCHAR(20);
  cli_id VARCHAR(20);
BEGIN
  SELECT E.ID INTO emp_id
  FROM EMPLOYEE E
  LEFT JOIN CUSTOMER C 
    ON(E.ID = C.EMPLOYEE_ID)
  GROUP BY E.ID
  HAVING COUNT(C.ID)= (
    SELECT MAX(COUNT(C.ID))
    FROM CUSTOMER C
    LEFT JOIN EMPLOYEE E
      ON(C.EMPLOYEE_ID = E.ID)
    GROUP BY E.ID
  );
  DBMS_OUTPUT.PUT_LINE('Empleat amb més clients, té un ID: ' || emp_id);

  SELECT C.ID INTO cli_id
  FROM CUSTOMER C
  LEFT JOIN EMPLOYEE E
    ON(C.EMPLOYEE_ID = E.ID)
  INNER JOIN PRODUCT_CUSTOMER PC
    ON(C.ID = PC.CUSTOMER_ID)
  WHERE E.ID=2
  GROUP BY C.ID
  HAVING COUNT(C.ID) = (
    SELECT MAX(COUNT(C.ID))
    FROM CUSTOMER C
    LEFT JOIN EMPLOYEE E
      ON(C.EMPLOYEE_ID = E.ID)
    INNER JOIN PRODUCT_CUSTOMER PC
      ON(C.ID = PC.CUSTOMER_ID)
    WHERE E.ID=2
    GROUP BY C.ID
  );
  DBMS_OUTPUT.PUT_LINE('Client amb és productes, té un ID: ' || cli_id);
  
  SELECT C.NAME INTO cli_nom
  FROM CUSTOMER C
  LEFT JOIN EMPLOYEE E
    ON(C.EMPLOYEE_ID = E.ID)
  INNER JOIN PRODUCT_CUSTOMER PC
    ON(C.ID = PC.CUSTOMER_ID)
  WHERE E.ID=2
  GROUP BY C.ID, C.NAME
  HAVING COUNT(C.ID) = (
    SELECT MAX(COUNT(C.ID))
    FROM CUSTOMER C
    LEFT JOIN EMPLOYEE E
      ON(C.EMPLOYEE_ID = E.ID)
    INNER JOIN PRODUCT_CUSTOMER PC
      ON(C.ID = PC.CUSTOMER_ID)
    WHERE E.ID=2
    GROUP BY C.ID
  );
  DBMS_OUTPUT.PUT_LINE('El nom del client amb més productes és: ' || cli_nom);
END;